name: prepare_hermes_workspace
description: Prepare Hermes Workspace
outputs:
  react-native-version:
    description: The version of React Native for this build
    value: ${{ steps.react-native-version.outputs.version }}
  hermes-version:
    description: The version of Hermes for this build
    value: ${{ steps.hermes-version.outputs.version }}
runs:
  using: composite
  steps:
    - name: Setup node.js
      uses: ./.github/actions/setup-node
    - name: Setup hermes version
      shell: bash
      id: hermes-version
      run: |
        mkdir -p "/tmp/hermes" "/tmp/hermes/download" "/tmp/hermes/hermes"

        if [ -f "$HERMES_VERSION_FILE" ]; then
          echo "Hermes Version file found! Using this version for the build:"
          echo "VERSION=$(cat $HERMES_VERSION_FILE)" >> "$GITHUB_OUTPUT"
        else
          echo "Hermes Version file not found!!!"
          echo "Using the last commit from main for the build:"
          HERMES_TAG_SHA=$(git ls-remote https://github.com/$GITHUB_REPOSITORY main | cut -f 1 | tr -d '[:space:]')
          echo "VERSION=$HERMES_TAG_SHA" >> "$GITHUB_OUTPUT"
        fi
        echo "Hermes commit is $HERMES_TAG_SHA"
    - name: Get react-native version
      shell: bash
      id: react-native-version
      run: |
        VERSION=$(cat packages/react-native/package.json | jq -r '.version')
        # Save the react native version we are building in an output variable so we can use that file as part of the cache key.
        echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
        echo "React Native Version is $VERSION"
    - name: Cache hermes workspace
      uses: actions/cache@v4.0.0
      with:
        path: |
          /tmp/hermes/download/
          /tmp/hermes/hermes/
        key: v1-hermes-${{ steps.hermes-version.outputs.version }}-${{ github.run_number }}
        enableCrossOsArchive: true
    - name: Yarn- Install Dependencies
      shell: bash
      run: yarn install --non-interactive
    - name: Download Hermes tarball
      shell: bash
      run: |
        node packages/react-native/scripts/hermes/prepare-hermes-for-build ${{ github.event.pull_request.html_url }}
        cp packages/react-native/sdks/download/* $HERMES_WS_DIR/download/.
        cp -r packages/react-native/sdks/hermes/* $HERMES_WS_DIR/hermes/.

        echo ${{ steps.hermes-version.outputs.version }}
